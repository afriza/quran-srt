<html>
<head>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<!-- Tell the browser to be responsive to screen width -->
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta name="description" content="Quran Translation SRT Subtitle">
	<meta name="author" content="Afriza N. Arief">
	<title>Download All Translated Languages of The Holy Quran</title>
	<!-- Bootstrap Core CSS -->
	<link href="/assets/plugins/bootstrap/css/bootstrap.min.css" rel="stylesheet">
	<link href="/assets/plugins/bootstrap-datepicker/bootstrap-datepicker.min.css" rel="stylesheet" type="text/css" />
	<!-- morris CSS -->
	<link href="/assets/plugins/morrisjs/morris.css" rel="stylesheet">
	<link href="/assets/plugins/sweetalert/sweetalert.css" rel="stylesheet" type="text/css">
	<link href="/assets/plugins/select2/dist/css/select2.min.css" rel="stylesheet" type="text/css">
	<!-- Custom CSS -->
	<link href="/css/style.css" rel="stylesheet">
	<!-- You can change the theme colors from here -->
	<link href="/css/colors/blue.css" id="theme" rel="stylesheet">
	<!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
	<!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
	<!--[if lt IE 9]>
	<script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
	<script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
	<![endif]-->

	<script src="/assets/plugins/jquery/jquery.min.js"></script>
	<script src="/assets/plugins/popper/popper.min.js"></script>
	<script src="/assets/plugins/bootstrap/js/bootstrap.min.js"></script>
	<script src="/js/jquery.slimscroll.js"></script>
	<script src="/js/waves.js"></script>
	<script src="/js/sidebarmenu.js"></script>
	<script src="/assets/plugins/sticky-kit-master/dist/sticky-kit.min.js"></script>
	<script src="/js/custom.min.js"></script>
	<script src="/assets/plugins/sparkline/jquery.sparkline.min.js"></script>
	<script src="/assets/plugins/raphael/raphael-min.js"></script>
	<script src="/assets/plugins/morrisjs/morris.min.js"></script>
	<!--<script src="/js/dashboard1.js"></script>-->
	<script src="/assets/plugins/styleswitcher/jQuery.style.switcher.js"></script>
	<script src="/assets/plugins/datatables/jquery.dataTables.min.js"></script>
	<script src="/assets/plugins/bootstrap-datepicker/bootstrap-datepicker.min.js"></script>
	<script src="/assets/plugins/blockUI/jquery.blockUI.js"></script>
	<script src="/assets/plugins/sweetalert/sweetalert.min.js"></script>
	<script src="/assets/plugins/select2/dist/js/select2.min.js"></script>
	<script src="/assets/plugins/datatables/natural.js"></script>
	<script src="/js/js.cookie.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/wretch/2.5.2/wretch.min.js" integrity="sha512-ODUFGt849cHLqlJP/v/oweHgkM+t31GgIsGZPLka5uDiRpclLfZAXusSOQXGieA4aLUC0bjq4ua1X6uJ9oVA1A==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

	<style>
		body {
			zoom: 90%;
		}

		.table td, .table th {
			padding: .50rem;
		}

		.container-fluid {
			padding: 0 15px 15px 15px;
		}

		.page-titles {
			margin: 0 0px 15px;
			padding: 10px 5px;
		}

		.table.dataTable tbody tr td.dataTables_empty {
			text-align: center;
		}
	</style>
</head>
<body class="fix-header fix-sidebar card-no-border">

<div id="main-wrapper">
	<header class="topbar">
		<nav class="navbar top-navbar navbar-expand-md navbar-light">
			<div class="navbar-collapse">
				<!-- ============================================================== -->
				<!-- toggle and nav items -->
				<!-- ============================================================== -->
				<ul class="navbar-nav mr-auto mt-md-0">
					<!-- This is  -->
					<li class="nav-item"> <a class="nav-link nav-toggler hidden-md-up text-muted waves-effect waves-dark" href="javascript:void(0)"><i class="mdi mdi-menu"></i>Change Translations</a> </li>
					<li class="nav-item m-l-10"> <a class="nav-link sidebartoggler hidden-sm-down text-muted waves-effect waves-dark" href="javascript:void(0)"><i class="ti-menu"></i>Change Translations</a> </li>
				</ul>
			</div>
		</nav>
	</header>

	<aside class="left-sidebar" style="width: auto">
		<div class="scroll-sidebar">
			<nav class="sidebar-nav">
				<ul id="sidebarnav">

					<li id="lang_sample" class="hide lang"><a class="waves-effect waves-dark" href="#" aria-expanded="false"><i class="fa fa-list"></i><span class="hide-menu"><span class="lang-name">Sample</span>
							<div class="form-check">
								<input class="form-check-input hide lang-id" type="radio" name="sample" id="sample-1" value="1">
								<label class="form-check-label lang-label" for="sample-1">Dr. Mustafa Khattab</label>
							</div>
							</span></a>
					</li>

				</ul>
			</nav>
		</div>
	</aside>

<div class="page-wrapper">
	<div class="row page-titles">
		<div class="col-md-12 align-self-center">
			<h3 class="text-themecolor">Download All Translated Languages of The Holy Quran</h3>
		</div>
	</div>
	<div class="container-fluid">

	<div class="row">
		<div class="col-md-12">
			<div class="card">
				<div class="card-body">
					<form id="input-form" class="form-horizontal form-material needs-validation" action="" method="POST" enctype="multipart/form-data">

					<h5>Download All Translated Languages of The Holy Quran</h5>
					<hr>

					<div class="row">
						<div class="form-group col-md-6">
							<label class="font-weight-bold" for="surah_list">Surah Number / Name	</label>
							<select class="select2 form-control form-control-line" id="surah_list" name="surah_list" onchange="surah_changed(this)">
								<option value="">-- Surah Number &amp; Name --</option>
							</select>
						</div>

						<div class="form-group col-md-3">
							<label class="font-weight-bold" for="ayah_first">First Ayah</label>
							<input type="number" id="ayah_first" name="ayah_first" min="1" value=""
								pattern="[0-9]+" placeholder=""
								class="form-control form-control-line" required>
						</div>

						<div class="form-group col-md-3">
							<label class="font-weight-bold" for="ayah_last">Last Ayah</label>
							<input type="number" id="ayah_last" name="ayah_last" min="1" value=""
								pattern="[0-9]+" placeholder=""
								class="form-control form-control-line" required>
							</select>
						</div>

						<div class="form-group col-md-3">
							<button onclick="surah_ayah_update()" type="button" class="btn btn-outline-success btn-sm">Update</button>
						</div>
					</div>

					<div class="table-responsive">
						<table id="table-ayah" class="display nowrap table table-hover table-bordered"
							   cellspacing="0" width="100%">
						<thead>
							<tr>
								<th>Ayah</th>
								<th>Start</th>
								<th>End</th>
								<th>Translation Preview</th>
							</tr>
						</thead>
						<tbody>
							<tr>
								<td>Ayah #</td>
								<td>
									<input type="text" id="start_1" name="start_1" value=""
										pattern="([0-9]{1,2}:){0,2}[0-9]+([.][0-9]+)?" placeholder="1:02:03.456" size="13" maxlength="13"
										required> <!-- class="form-control form-control-line" -->
								</td>
								<td>
									<input type="text" id="end_1" name="end_1" value=""
										pattern="([0-9]{1,2}:){0,2}[0-9]+([.][0-9]+)?" placeholder="1:02:03.456" size="13" maxlength="13"
										required> <!-- class="form-control form-control-line" -->
								</td>
								<td>Translation Preview</td>
							</tr>
						</tbody>
						</table>
					</div>

					<div class="form-group">
						<div class="col-sm-12">
							<button id="zip_prepare" class="btn btn-info" type="submit">Prepare zipped SRT files</button>
							<span id="progress"></span>
							<button id="zip_download" onclick="download_zip()" class="btn btn-info hide" type="button" disabled>Download zipped SRT files</button>
						</div>
					</div>

					</form>
				</div>
			</div>

		</div>
		<!-- Column -->
	</div>

	</div>
</div>
</div>

<script type="text/javascript" src="https://gildas-lormeau.github.io/zip.js/demos/lib/zip.js"></script>
<script type="text/javascript" src="/js/jszip.min.js"></script>
<script type="text/javascript" src="/js/FileSaver.min.js"></script>
<script>
let surah = null
let chapters = null
let translations = null
let ayah_trns = null
let promise_zip = null

let lang_list = $('#sidebarnav')
let lang_sample = $('#lang_sample')
let surah_list = $('#surah_list')
let ayah_first = $('#ayah_first')
let ayah_last = $('#ayah_last')
let zip_download = $('#zip_download')
let progress = $('#progress')

let api = wretch('https://api.quran.com/api/v4')

function list_surah() {
	api.get('/chapters').json(jo => {
		let data = []
		chapters = jo.chapters
		chapters.forEach(el => {
			data.push({
				id: el.id,
				text: `${pad_zero(el.id,3)}. ${el.name_simple} (${el.translated_name.name})`
			})
			surah_list.select2({data})
		})
	})
}

function list_translations() {
	api.get('/resources/translations').json(jo => {
		translations = jo.translations
		let m = translations.m = {} // map
		translations.forEach(trn => {
			m[trn.id] = trn
			let lang_name = trn.language_name.toLowerCase()
			let lang_name_id = lang_name.replace(' ','-')
			let li = lang_list.find('#'+ lang_name_id)
			let el, trn_name
			if (li.length > 0) {
				let el_div_last = li.find('div').last()
				let el_div = el_div_last.clone()
				el_div.find('input').prop('checked', false)
				trn_name = set_trn_lang(el_div, trn, lang_name)
				el_div_last.after(el_div)
				el = el_div
			} else {
				let lis = lang_list.find('li')
				let el_li = lang_sample.clone()
				el_li.attr('id', lang_name_id)
				el_li.find('span[class=lang-name]').text(pad_zero(lis.length,2) +'. '+ upper_words_first(lang_name))
				el_li.removeClass('hide')
				el_li.find('input').attr('name', lang_name)
				el_li.find('input').prop('checked', true)
				trn_name = set_trn_lang(el_li, trn, lang_name)
				lang_sample.before(el_li)
				el = el_li
			}
			if (el.is('div')) {
				el = el.parent()
			}
			trn.fname = el.find('span[class=lang-name]').text() +'. '+ trn_name +'.srt'
		})
	})
}

function set_trn_lang(el, trn, lang_name) {
	let elem = $(el)
	let el_input = elem.find('input')
	el_input.attr('id', `${lang_name}-${trn.id}`)
	el_input.attr('value', trn.id)
	let el_label =  elem.find('label')
	el_label.attr('for', `${lang_name}-${trn.id}`)
	let text = trn.name
	if (!text.includes(trn.author_name)) {
		//text += '; ' + trn.author_name
	}
	el_label.text(text)
	return text
}

function surah_changed(el) {
	let id = el.options[el.selectedIndex].value
	surah = chapters?.[id-1]
	if (surah) {
		let n = surah.verses_count
		ayah_first.attr('max', n)
		ayah_first.attr('placeholder', 'max: ' + n)
		ayah_last.attr('max', n)
		ayah_last.attr('placeholder', 'max: ' + n)
	} else {
		ayah_first.attr('placeholder', '')
		ayah_last.attr('placeholder', '')
	}
}

function surah_ayah_update() {
	let n = surah?.verses_count
	let f = ayah_first.val()
	let l = ayah_last.val()
	let ok = f >= 1 && l >= 1 && f <= n && l <= n && f <= l
	if (!ok) {
		alert('Please use valid surah and ayah range!')
		return
	}
	zip_download.addClass('hide')
	progress.text('')
	let trn_id = $('input[name=english]:checked').val()
	api.get('/quran/translations/'+trn_id+'?chapter_number='+surah.id).json(jo => {
		let trns = jo.translations
		trns.forEach((el, i, a) => {
			let id = i+1
			a[i].id = id
			a[i].start_html = `
				<input type="text" id="start_${id}" name="start_${id}"
					value="" pattern="([0-9]{1,2}:){0,2}[0-9]+([.,][0-9]{1,3})?"
					placeholder="1:02:03.456" size="13" maxlength="13"
					required>`
			a[i].end_html = `
				<input type="text" id="end_${id}" name="end_${id}"
					value="" pattern="([0-9]{1,2}:){0,2}[0-9]+([.,][0-9]{1,3})?"
					placeholder="1:02:03.456" size="13" maxlength="13"
					required>`
		})
		trns = trns.filter(el => el.id >= f && el.id <= l)
		ayah_trns = {shown_trn: trn_id}
		ayah_trns[trn_id] = {
			trns,
			meta: jo.meta,
		}
		$('#table-ayah').DataTable({
			destroy: true,
			data: trns,
			columns: [
				{ data: 'id' },
				{ data: 'start_html' },
				{ data: 'end_html' },
				{ data: 'text' },
			],
		})
	})
}

$(function(){
	$('#table-ayah').DataTable({
		order: [[0, 'asc']],
	});

	list_surah()
	list_translations()
	$('#input-form').submit(prepare_zip)
})

function upper_words_first(str) {
	let s = ''
	let i = 0
	do {
		str = str.substring(0,1).toUpperCase()+str.substring(1)
		let m = str.match(/[ ,-]/)
		i = (m?.index ?? -1) + 1
		s += str.substring(0, i)
		str = str.substring(i)
	} while (i > 0)
	s += str
	return s
}

function srt_fmt_ts(ts) {
	if (typeof ts != 'string') {
		return ''
	}
	let match = ts.match(/^(?:([0-9]{1,2}):)??(?:([0-9]{1,2}):)?([0-9]+)(?:[.,]([0-9]{1,3}))?$/)
	if (!match) {
		return ''
	}
	let ms = match[4] ?? 0
	ms = pad_zero(ms, -3) | 0
	ms += (match[3] ?? 0) * 1000
	ms += (match[2] ?? 0) * 1000*60
	ms += (match[1] ?? 0) * 1000*60*60
	let s =  ms/1000 | 0
	let m = s/60 | 0
	let h = m/60 | 0
	ms = ms % 1000
	s = s % 60
	m = m % 60
	ms = pad_zero(ms, 3)
	s = pad_zero(s, 2)
	m = pad_zero(m, 2)
	h = pad_zero(h, 2)
	return `${h}:${m}:${s},${ms}`
}

function pad_zero(num, size) {
	// Ref: https://stackoverflow.com/a/2998822/109747
	num = num.toString()
	let left = true
	if (size < 0) {
		left = false
		size = -size
	}
	while (num.length < size) {
		if (left) {
			num = "0" + num
		} else {
			num += "0"
		}
	}
	return num
}

async function gen_srt(trn_id, surah_id, ayah_f, ayah_l) {
	let jo = await api.get('/quran/translations/'+trn_id+'?chapter_number='+surah_id).json()
	let trns = jo.translations
	trns.forEach((el, i, a) => {
		let id = i+1
		el.id = id
	})
	trns = trns.filter(el => el.id >= ayah_f && el.id <= ayah_l)
	
	let srt = trns.map((ayah_trn, idx) => {
		let start = $('#start_'+ ayah_trn.id).val()
		let end = $('#end_'+ ayah_trn.id).val()
		start = srt_fmt_ts(start)
		end = srt_fmt_ts(end)
		return `${idx+1}\n`+
			`${start} --> ${end}\n`+
			`${ayah_trn.text}\n\n`
	}).join('')
	return srt
}

async function prepare_zip(ev) {
	ev.preventDefault()
	zip_download.prop('disabled', true)
	zip_download.addClass('hide')

	let zip = new JSZip()
	let surah_id = surah_list.val()
	let ayah_f = ayah_first.val()
	let ayah_l = ayah_last.val()
	let langs = $('.lang-id:checked')
	for (let i=0; i<langs.length; i++) {
		let trn_id = langs[i].value
		let fname = translations?.m?.[trn_id]?.fname
		progress.text(`preparing "${fname}"`)
		let srt = await gen_srt(trn_id, surah_id, ayah_f, ayah_l)
		zip.file(fname, srt)
	}
	progress.text(`done!`)
	promise_zip = zip.generateAsync({type : "blob"});

	/*
	let trn_id = ayah_trns?.shown_trn
	let fname = translations?.m?.[trn_id]?.fname
	let srt = ayah_trns?.[trn_id]?.trns.map((ayah_trn, idx) => {
		let start = $('#start_'+ ayah_trn.id).val()
		let end = $('#end_'+ ayah_trn.id).val()
		start = srt_fmt_ts(start)
		end = srt_fmt_ts(end)
		return `${idx+1}\n`+
			`${start} --> ${end}\n`+
			`${ayah_trn.text}\n\n`
	}).join('')
	console.log('srt: %o', srt)
	*/

	zip_download.prop('disabled', false)
	zip_download.removeClass('hide')
}

async function download_zip() {
	console.log('zip_down')
	let ayah_f = ayah_first.val()
	let ayah_l = ayah_last.val()
	let d = new Date()
	let ts = `${d.getFullYear()}-${pad_zero(d.getMonth(),2)}-${pad_zero(d.getDate(),2)}T${pad_zero(d.getHours(),2)}${pad_zero(d.getMinutes(),2)}${pad_zero(d.getSeconds(),2)}`
	let zip_name = `${pad_zero(surah.id,3)} ${surah.name_simple} (${surah.translated_name?.name}) ${ayah_f}-${ayah_l} ${ts}.zip`
	let blob = await promise_zip
	saveAs(blob, zip_name)
}
</script>

</body>
</html>
