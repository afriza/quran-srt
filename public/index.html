<html>
<head>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<!-- Tell the browser to be responsive to screen width -->
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta name="description" content="Quran Translation SRT Subtitle">
	<meta name="author" content="Afriza N. Arief">
	<title>Download All Translated Languages of The Holy Quran</title>
	<script>
function redirHttps() {
	if (location.protocol != 'http:')
		return;
	try {
		let url = 'https://' + location.hostname + '/gen_OK'
		let xhr = new XMLHttpRequest()
		xhr.onreadystatechange = function() {
			if (this.readyState == XMLHttpRequest.DONE && 
				this.status == 200 && this.responseText == 'OK') {
				// https cert valid. switch to https version.
				location = 'https://' + location.hostname + location.pathname
			}
		}
		xhr.open("GET", url, true)
		xhr.send()
	} catch (e) {
		console.log('redirHttps: %s | %o', e && e.message || JSON.stringify(e), e)
	}
}
redirHttps()
	</script>
	<!-- Bootstrap Core CSS -->
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.2.3/css/bootstrap.min.css" integrity="sha512-SbiR/eusphKoMVVXysTKG/7VseWii+Y3FdHrt0EpKgpToZeemhqHeZeLWLhJutz/2ut2Vw1uQEj2MbRF+TVBUA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.10.0/css/bootstrap-datepicker.min.css" integrity="sha512-34s5cpvaNG3BknEWSuOncX28vz97bRI59UnVtEEpFX536A7BtZSJHsDyFoCl8S7Dt2TPzcrCEoHBGeM4SUBDBw==" crossorigin="anonymous" referrerpolicy="no-referrer" />
	<!-- morris CSS -->
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/morris.js/0.5.1/morris.css" integrity="sha512-fjy4e481VEA/OTVR4+WHMlZ4wcX/+ohNWKpVfb7q+YNnOCS++4ZDn3Vi6EaA2HJ89VXARJt7VvuAKaQ/gs1CbQ==" crossorigin="anonymous" referrerpolicy="no-referrer" />
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/css/select2.min.css" integrity="sha512-nMNlpuaDPrqlEls3IX/Q56H36qvBASwb3ipuo3MxeWbsQB1881ox0cRv7UPTgBlriqoynt35KjEwgGUeUXIPnw==" crossorigin="anonymous" referrerpolicy="no-referrer" />
	<!--link href="/assets/plugins/sweetalert/sweetalert.css" rel="stylesheet" type="text/css"-->
	<!-- Custom CSS -->
	<link href="/css/style.css" rel="stylesheet">
	<!-- You can change the theme colors from here -->
	<link href="/css/colors/blue.css" id="theme" rel="stylesheet">
	<!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
	<!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
	<!--[if lt IE 9]>
	<script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
	<script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
	<![endif]-->

	<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.0/jquery.min.js" integrity="sha512-3gJwYpMe3QewGELv8k/BX9vcqhryRdzRMxVfq6ngyWXwo03GFEzjsUm8Q7RZcHPHksttq7/GFoxjCVUjkjvPdw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/2.11.7/umd/popper.min.js" integrity="sha512-uaZ0UXmB7NHxAxQawA8Ow2wWjdsedpRu7nJRSoI2mjnwtY8V5YiCWavoIpo1AhWPMLiW5iEeavmA3JJ2+1idUg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.2.3/js/bootstrap.bundle.min.js" integrity="sha512-i9cEfJwUwViEPFKdC1enz4ZRGBj8YQo6QByFTF92YXHi7waCqyexvRD75S5NVTsSiTv7rKWqG9Y5eFxmRsOn0A==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/jQuery-slimScroll/1.3.8/jquery.slimscroll.min.js" integrity="sha512-cJMgI2OtiquRH4L9u+WQW+mz828vmdp9ljOcm/vKTQ7+ydQUktrPVewlykMgozPP+NUBbHdeifE6iJ6UVjNw5Q==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/node-waves/0.7.6/waves.min.js" integrity="sha512-MzXgHd+o6pUd/tm8ZgPkxya3QUCiHVMQolnY3IZqhsrOWQaBfax600esAw3XbBucYB15hZLOF0sKMHsTPdjLFg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/sticky-kit/1.1.3/sticky-kit.min.js" integrity="sha512-MAhdSIQcK5z9i33WN0KzveJUhM2852CJ1lJp4o60cXhQT20Y3friVRdeZ5TEWz4Pi+nvaQqnIqWJJw4HVTKg1Q==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-sparklines/2.1.2/jquery.sparkline.min.js" integrity="sha512-3PRVLmoBYuBDbCEojg5qdmd9UhkPiyoczSFYjnLhFb2KAFsWWEMlAPt0olX1Nv7zGhDfhGEVkXsu51a55nlYmw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/raphael/2.3.0/raphael.min.js" integrity="sha512-tBzZQxySO5q5lqwLWfu8Q+o4VkTcRGOeQGVQ0ueJga4A1RKuzmAu5HXDOXLEjpbKyV7ow9ympVoa6wZLEzRzDg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/morris.js/0.5.1/morris.min.js" integrity="sha512-6Cwk0kyyPu8pyO9DdwyN+jcGzvZQbUzQNLI0PadCY3ikWFXW9Jkat+yrnloE63dzAKmJ1WNeryPd1yszfj7kqQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/datatables/1.10.21/js/jquery.dataTables.min.js" integrity="sha512-BkpSL20WETFylMrcirBahHfSnY++H2O1W+UnEEO4yNIl+jI2+zowyoGJpbtk6bx97fBXf++WJHSSK2MV4ghPcg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/datatables-plugins/1.13.4/sorting/natural.min.js" integrity="sha512-b8/ohttnZNFHEuwYniDnD2dTZ1R2DCWTwdm0mJf/j7F3IGwSDZf7/gToFIL6g9jXO/lYPklga82EeC1cVLmETw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.10.0/js/bootstrap-datepicker.min.js" integrity="sha512-LsnSViqQyaXpD4mBBdRYeP6sRwJiJveh2ZIbW41EBrNmKxgr/LFZIiWT6yr+nycvhvauz8c2nYMhrP80YhG7Cw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.blockUI/2.70/jquery.blockUI.min.js" integrity="sha512-eYSzo+20ajZMRsjxB6L7eyqo5kuXuS2+wEbbOkpaur+sA2shQameiJiWEzCIDwJqaB0a4a6tCuEvCOBHUg3Skg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/sweetalert/2.1.2/sweetalert.min.js" integrity="sha512-AA1Bzp5Q0K1KanKKmvN/4d3IRKVlv9PYgwFPvm32nPO6QS8yH1HO7LbgB1pgiOxPtfeg5zEn2ba64MUcqJx6CA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/js/select2.min.js" integrity="sha512-2ImtlRlf2VVmiGZsjm9bEyhjGW4dU7B6TNwh/hx/iSByxNENtj3WVE6o/9Lj4TJeVXPi4bnOIMXFIJJAeufa0A==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/js-cookie/3.0.5/js.cookie.min.js" integrity="sha512-nlp9/l96/EpjYBx7EP7pGASVXNe80hGhYAUrjeXnu/fyF5Py0/RXav4BBNs7n5Hx1WFhOEOWSAVjGeC3oKxDVQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/wretch/2.5.2/wretch.min.js" integrity="sha512-ODUFGt849cHLqlJP/v/oweHgkM+t31GgIsGZPLka5uDiRpclLfZAXusSOQXGieA4aLUC0bjq4ua1X6uJ9oVA1A==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js" integrity="sha512-XMVd28F1oH/O71fzwBnV7HucLxVwtxf26XV8P4wPk26EDxuGZ91N8bsOttmnomcCD3CS5ZMRL50H0GgOHvegtg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js" referrerpolicy="no-referrer"></script>
	<!--script src="/assets/plugins/styleswitcher/jQuery.style.switcher.js"></script-->
	<script src="/js/sidebarmenu.js"></script>
	<script src="/js/custom.min.js"></script>

	<style>
		body {
			zoom: 90%;
		}

		.table td, .table th {
			padding: .50rem;
		}

		.container-fluid {
			padding: 0 15px 15px 15px;
		}

		.page-titles {
			margin: 0 0px 15px;
			padding: 10px 5px;
		}

		.table.dataTable tbody tr td.dataTables_empty {
			text-align: center;
		}
	</style>
</head>
<body class="fix-header fix-sidebar card-no-border">

<div id="main-wrapper">
	<header class="topbar">
		<nav class="navbar top-navbar navbar-expand-md navbar-light">
			<div class="navbar-collapse">
				<!-- ============================================================== -->
				<!-- toggle and nav items -->
				<!-- ============================================================== -->
				<ul class="navbar-nav mr-auto mt-md-0">
					<!-- This is  -->
					<li class="nav-item"> <a class="nav-link nav-toggler hidden-md-up text-muted waves-effect waves-dark" href="javascript:void(0)"><i class="mdi mdi-menu"></i>Change Translations</a> </li>
					<li class="nav-item m-l-10"> <a class="nav-link sidebartoggler hidden-sm-down text-muted waves-effect waves-dark" href="javascript:void(0)"><i class="ti-menu"></i>Change Translations</a> </li>
				</ul>
			</div>
		</nav>
	</header>

	<aside class="left-sidebar" style="width: auto">
		<div class="scroll-sidebar">
			<nav class="sidebar-nav">
				<ul id="sidebarnav">

					<li id="lang_sample" class="hide lang"><a class="waves-effect waves-dark" href="#" aria-expanded="false"><i class="fa fa-list"></i><span class="hide-menu"><span class="lang-name">Sample</span>
							<div class="form-check">
								<input class="form-check-input hide lang-id" type="radio" name="sample" id="sample-1" value="1">
								<label class="form-check-label lang-label" for="sample-1">Dr. Mustafa Khattab</label>
							</div>
							</span></a>
					</li>

				</ul>
			</nav>
		</div>
	</aside>

<div class="page-wrapper">
	<div class="row page-titles">
		<div class="col-md-12 align-self-center">
			<h3 class="text-themecolor">Download All Translated Languages of The Holy Quran</h3>
		</div>
	</div>
	<div class="container-fluid">

	<div class="row">
		<div class="col-md-12">
			<div class="card">
				<div class="card-body">
					<form id="input-form" class="form-horizontal form-material needs-validation" action="" method="POST" enctype="multipart/form-data">

					<h5>Download All Translated Languages of The Holy Quran</h5>
					<hr>

					<div class="row">
						<div class="form-group col-md-6">
							<label class="font-weight-bold" for="surah_list">Surah Number / Name	</label>
							<select class="select2 form-control form-control-line" id="surah_list" name="surah_list" onchange="surah_changed(this)">
								<option value="">-- Surah Number &amp; Name --</option>
							</select>
						</div>

						<div class="form-group col-md-3">
							<label class="font-weight-bold" for="ayah_first">First Ayah</label>
							<input type="number" id="ayah_first" name="ayah_first" min="1" value=""
								pattern="[0-9]+" placeholder=""
								class="form-control form-control-line" required>
						</div>

						<div class="form-group col-md-3">
							<label class="font-weight-bold" for="ayah_last">Last Ayah</label>
							<input type="number" id="ayah_last" name="ayah_last" min="1" value=""
								pattern="[0-9]+" placeholder=""
								class="form-control form-control-line" required>
							</select>
						</div>

						<div class="form-group col-md-3">
							<button onclick="surah_ayah_update()" type="button" class="btn btn-outline-success btn-sm">Update</button>
						</div>
					</div>

					<div class="table-responsive">
						<table id="table-ayah" class="display nowrap table table-hover table-bordered"
							   cellspacing="0" width="100%">
						<thead>
							<tr>
								<th>Ayah</th>
								<th>Start</th>
								<th>End</th>
								<th>Translation Preview</th>
							</tr>
						</thead>
						<tbody>
							<tr>
								<td>Ayah #</td>
								<td>
									<input type="text" id="start_1" name="start_1" value=""
										pattern="([0-9]{1,2}:){0,2}[0-9]+([.][0-9]+)?" placeholder="1:02:03.456" size="13" maxlength="13"
										required> <!-- class="form-control form-control-line" -->
								</td>
								<td>
									<input type="text" id="end_1" name="end_1" value=""
										pattern="([0-9]{1,2}:){0,2}[0-9]+([.][0-9]+)?" placeholder="1:02:03.456" size="13" maxlength="13"
										required> <!-- class="form-control form-control-line" -->
								</td>
								<td>Translation Preview</td>
							</tr>
						</tbody>
						</table>
					</div>

					<div class="form-group">
						<div class="col-sm-12">
							<button id="zip_prepare" class="btn btn-info" type="submit">Prepare zipped SRT files</button>
							<span id="progress"></span>
							<button id="zip_download" onclick="download_zip()" class="btn btn-info hide" type="button" disabled>Download zipped SRT files</button>
						</div>
					</div>

					</form>
				</div>
			</div>

		</div>
		<!-- Column -->
	</div>

	</div>
</div>
</div>

<script>
let surah = null
let chapters = null
let translations = null
let ayah_trns = null
let promise_zip = null

let lang_list = $('#sidebarnav')
let lang_sample = $('#lang_sample')
let surah_list = $('#surah_list')
let ayah_first = $('#ayah_first')
let ayah_last = $('#ayah_last')
let zip_prepare = $('#zip_prepare')
let zip_download = $('#zip_download')
let progress = $('#progress')

let api = wretch('https://api.quran.com/api/v4')

function list_surah() {
	api.get('/chapters').json(jo => {
		let data = []
		chapters = jo.chapters
		chapters.forEach(el => {
			data.push({
				id: el.id,
				text: `${pad_zero(el.id,3)}. ${el.name_simple} (${el.translated_name.name})`
			})
			surah_list.select2({data})
		})
	})
}

function list_translations() {
	api.get('/resources/translations').json(jo => {
		translations = jo.translations
		let m = translations.m = {} // map
		translations.forEach(trn => {
			m[trn.id] = trn
			let lang_name = trn.language_name.toLowerCase()
			let lang_name_id = 'trn-'+ lang_name.replace(' ','-').replace(',','_')
			let li = lang_list.find('#'+ lang_name_id)
			let c = Cookies.get(lang_name_id)
			let el, trn_name
			if (li.length > 0) {
				let el_div_last = li.find('div').last()
				let el_div = el_div_last.clone()
				el_div.find('input').prop('checked', c == trn.id)
				trn_name = set_trn_lang(el_div, trn, lang_name_id)
				el_div_last.after(el_div)
				el = el_div
			} else {
				let lis = lang_list.find('li')
				let el_li = lang_sample.clone()
				el_li.attr('id', lang_name_id)
				el_li.find('span[class=lang-name]').text(pad_zero(lis.length,2) +'. '+ upper_words_first(lang_name))
				el_li.removeClass('hide')
				el_li.find('input').attr('name', lang_name_id)
				el_li.find('input').prop('checked', !c || c == trn.id)
				trn_name = set_trn_lang(el_li, trn, lang_name_id)
				lang_sample.before(el_li)
				el = el_li
			}
			if (el.is('div')) {
				el = el.parent()
			}
			trn.fname = el.find('span[class=lang-name]').text() +'. '+ trn_name +'.srt'
		})
	})
}

function set_trn_lang(el, trn, lang_name_id) {
	let elem = $(el)
	let el_input = elem.find('input')
	el_input.attr('id', `${lang_name_id}-${trn.id}`)
	el_input.attr('value', trn.id)
	let el_label =  elem.find('label')
	el_label.attr('for', `${lang_name_id}-${trn.id}`)
	let text = trn.name
	el_label.text(text)
	el_input.change(ev => {
		Cookies.set(ev.target.name,ev.target.value)
	})
	return text
}

function surah_changed(el) {
	let id = el.options[el.selectedIndex].value
	surah = chapters?.[id-1]
	if (surah) {
		let n = surah.verses_count
		ayah_first.attr('max', n)
		ayah_first.attr('placeholder', 'max: ' + n)
		ayah_last.attr('max', n)
		ayah_last.attr('placeholder', 'max: ' + n)
	} else {
		ayah_first.attr('placeholder', '')
		ayah_last.attr('placeholder', '')
	}
}

async function surah_ayah_update() {
	let n = surah?.verses_count
	let f = ayah_first.val()
	let l = ayah_last.val()
	let ok = f >= 1 && l >= 1 && f <= n && l <= n && f <= l
	if (!ok) {
		alert('Please use valid surah and ayah range!')
		return
	}
	zip_download.addClass('hide')
	progress.text('')
	let trn_id = $('input[name=trn-english]:checked').val()
	try {
		let jo = await api.get('/quran/translations/'+trn_id+'?chapter_number='+surah.id).json()
		let trns = jo.translations
		trns.forEach((el, i, a) => {
			let id = i+1
			a[i].id = id
			a[i].id_pad = pad_zero(id, 3)
			a[i].start_html = `
				<input type="text" id="start_${id}" name="start_${id}"
					value="" pattern="([0-9]{1,2}:){0,2}[0-9]+([.,][0-9]{1,3})?"
					placeholder="1:02:03.456" size="13" maxlength="13"
					required>`
			a[i].end_html = `
				<input type="text" id="end_${id}" name="end_${id}"
					value="" pattern="([0-9]{1,2}:){0,2}[0-9]+([.,][0-9]{1,3})?"
					placeholder="1:02:03.456" size="13" maxlength="13"
					required>`
		})
		trns = trns.filter(el => el.id >= f && el.id <= l)
		ayah_trns = {shown_trn: trn_id}
		ayah_trns[trn_id] = {
			trns,
			meta: jo.meta,
		}
		$('#table-ayah').DataTable({
			destroy: true,
			data: trns,
			columns: [
				{ data: 'id_pad' },
				{ data: 'start_html' },
				{ data: 'end_html' },
				{ data: 'text' },
			],
		})
	} catch (err) {}
}

function upper_words_first(str) {
	let s = ''
	let i = 0
	do {
		str = str.substring(0,1).toUpperCase()+str.substring(1)
		let m = str.match(/[ ,-]/)
		i = (m?.index ?? -1) + 1
		s += str.substring(0, i)
		str = str.substring(i)
	} while (i > 0)
	s += str
	return s
}

function srt_fmt_ts(ts) {
	if (typeof ts != 'string') {
		return ''
	}
	let match = ts.match(/^(?:([0-9]{1,2}):)??(?:([0-9]{1,2}):)?([0-9]+)(?:[.,]([0-9]{1,3}))?$/)
	if (!match) {
		return ''
	}
	let ms = match[4] ?? 0
	ms = pad_zero(ms, -3) | 0
	ms += (match[3] ?? 0) * 1000
	ms += (match[2] ?? 0) * 1000*60
	ms += (match[1] ?? 0) * 1000*60*60
	let s =  ms/1000 | 0
	let m = s/60 | 0
	let h = m/60 | 0
	ms = ms % 1000
	s = s % 60
	m = m % 60
	ms = pad_zero(ms, 3)
	s = pad_zero(s, 2)
	m = pad_zero(m, 2)
	h = pad_zero(h, 2)
	return `${h}:${m}:${s},${ms}`
}

function pad_zero(num, size) {
	// Ref: https://stackoverflow.com/a/2998822/109747
	num = num.toString()
	let left = true
	if (size < 0) {
		left = false
		size = -size
	}
	while (num.length < size) {
		if (left) {
			num = "0" + num
		} else {
			num += "0"
		}
	}
	return num
}

async function gen_srt_ar(field, surah_id, ayah_f, ayah_l) {
	ayah_f |= 0
	ayah_l |= 0
	let trns = []
	for (let id=ayah_f; id<=ayah_l; id++) {
		let jo = await api.get(`/verses/by_key/${surah_id}:${id}?fields=${field}`).json()
		let text = jo?.verse?.[field]
		let ayah = {
			id,
			text,
		}
		trns.push(ayah)
	}

	let srt = trns.map((ayah_trn, idx) => {
		let start = $('#start_'+ ayah_trn.id).val()
		let end = $('#end_'+ ayah_trn.id).val()
		let text = $(`<span>${ayah_trn.text}</span>`)
		start = srt_fmt_ts(start)
		end = srt_fmt_ts(end)
		text = text.text()
		return `${idx+1}\n`+
			`${start} --> ${end}\n`+
			`${text}\n\n`
	}).join('')
	return srt
}

async function gen_srt(trn_id, surah_id, ayah_f, ayah_l) {
	let jo = await api.get('/quran/translations/'+trn_id+'?chapter_number='+surah_id).json()
	let trns = jo.translations
	trns.forEach((el, i, a) => {
		let id = i+1
		el.id = id
	})
	trns = trns.filter(el => el.id >= ayah_f && el.id <= ayah_l)
	
	let srt = trns.map((ayah_trn, idx) => {
		let start = $('#start_'+ ayah_trn.id).val()
		let end = $('#end_'+ ayah_trn.id).val()
		let text = $(`<span>${ayah_trn.text}</span>`)
		start = srt_fmt_ts(start)
		end = srt_fmt_ts(end)
		text = text.text()
		return `${idx+1}\n`+
			`${start} --> ${end}\n`+
			`${text}\n\n`
	}).join('')
	return srt
}

async function prepare_zip(ev) {
	ev.preventDefault()
	zip_prepare.prop('disabled', true)
	zip_download.prop('disabled', true)
	zip_download.addClass('hide')

	let zip = new JSZip()
	let surah_id = surah_list.val()
	let ayah_f = ayah_first.val()
	let ayah_l = ayah_last.val()
	let langs = $('.lang-id:checked')
	try {
		if (!surah_id || !ayah_trns) {
			alert('Please select surah and click [Update] button!')
			return
		}
		for (let i=0; i<langs.length; i++) {
			let trn_id = langs[i].value
			let fname = translations?.m?.[trn_id]?.fname
			progress.text(`preparing "${fname}"`)
			let srt = await gen_srt(trn_id, surah_id, ayah_f, ayah_l)
			zip.file(fname, srt)
		}

		let field = 'text_imlaei'
		let fname = `00. Arabic. ${upper_words_first(field.replace('_',' '))}.srt`
		progress.text(`preparing "${fname}"`)
		let srt = await gen_srt_ar(field, surah_id, ayah_f, ayah_l)
		zip.file(fname, srt)

		progress.text(`done!`)
		promise_zip = zip.generateAsync({type : "blob"});

		zip_download.prop('disabled', false)
		zip_download.removeClass('hide')
	} catch (err) {
		progress.text(err?.message || JSON.stringify(err))
	} finally {
		zip_prepare.prop('disabled', false)
	}
}

async function download_zip() {
	let ayah_f = ayah_first.val()
	let ayah_l = ayah_last.val()
	let d = new Date()
	let ts = `${d.getFullYear()}-${pad_zero(d.getMonth(),2)}-${pad_zero(d.getDate(),2)}T${pad_zero(d.getHours(),2)}${pad_zero(d.getMinutes(),2)}${pad_zero(d.getSeconds(),2)}`
	let zip_name = `${pad_zero(surah.id,3)} ${surah.name_simple} (${surah.translated_name?.name}) ${ayah_f}-${ayah_l} ${ts}.zip`
	let blob = await promise_zip
	saveAs(blob, zip_name)
}

$(function(){
	$('#table-ayah').DataTable({
		order: [[0, 'asc']],
	});

	list_surah()
	list_translations()
	$('#input-form').submit(prepare_zip)
})

</script>

</body>
</html>
